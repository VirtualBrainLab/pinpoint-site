---
import type {DefaultImageMetadata} from "../scripts/types";
interface Props {
    imageMetadatas: Promise<DefaultImageMetadata[]>;
	alt: string;
}

const {imageMetadatas, alt} = Astro.props;
---
{
    imageMetadatas.then((metadatas) => (
        <!--suppress HtmlUnknownTag -->
    <graphics-element data-srcs={JSON.stringify(metadatas.map(({default: {src}}) => src))}>
        <img class="max-w-full" src={metadatas[0].default.src} width={metadatas[0].default.width}
             height={metadatas[0].default.height} alt={alt}/>
    </graphics-element>
        ))
    }

<script>
    class Graphics extends HTMLElement {
        connectedCallback() {
            // Get components.
            const imageSrcs = JSON.parse(this.dataset.srcs ?? "[]");
            const numberOfImages = imageSrcs.length;
            const outputImage = this.querySelector("img") ?? (() => {
                throw new Error("Failed to get output image element");
            })();

            // Bind scroll event to draw images.
            window.addEventListener("scroll", () => {
                // Get the container bounds at this point.
                const containerBounds =
                    outputImage.parentElement?.parentElement?.parentElement?.parentElement?.getBoundingClientRect() ??
                    (() => {
                        throw new Error("Failed to get canvas containing element and bounds");
                    })();

                // Calculate where in the container we are.
                const scrollFraction =
                    (document.documentElement.scrollTop - containerBounds.top) /
                    (containerBounds.height);

                // Convert to the image index.
                const imageIndex = Math.min(
                    numberOfImages - 1,
                    Math.ceil(scrollFraction * numberOfImages),
                );

                // Draw it
                requestAnimationFrame(() => outputImage.src = imageSrcs[Math.max(0, Math.min(imageIndex, numberOfImages - 1))]);
            });
        }
    }

    customElements.define("graphics-element", Graphics);
</script>