---
import type { DefaultImageMetadata } from "../scripts/types";
interface Props {
	imageMetadatas: Promise<DefaultImageMetadata[]>;
}

const { imageMetadatas } = Astro.props;
---
{
    imageMetadatas.then((metadatas) => (
        <!--suppress HtmlUnknownTag -->
    <graphics-element data-image-srcs={JSON.stringify(metadatas.map(({default: {src}}) => src))}>
        <img class="max-w-full" src={metadatas[0].default.src} width={metadatas[0].default.width}
             height={metadatas[0].default.height} alt=""/>
    </graphics-element>
        ))
    }

<script>
    class Graphics extends HTMLElement {
        connectedCallback() {
            // Get components.
            const imageSrcs = JSON.parse(this.dataset.imageSrcs ?? "[]");
            const numberOfImages = imageSrcs.length;
            const outputImage = this.querySelector("img") ?? (() => {
                throw new Error("Failed to get output image element");
            })();

            // Bind scroll event to draw images.
            window.addEventListener("scroll", () => {
                // Get the container bounds at this point.
                const containerElement = outputImage.parentElement?.parentElement?.parentElement?.parentElement?.parentElement ?? (() => {
                    throw new Error("Failed to get section element");
                })();
                const containerBounds = containerElement.getBoundingClientRect();

                // Calculate where in the container we are.
                const scrollFraction =
                    (document.documentElement.scrollTop - containerElement.offsetTop) /
                    (containerBounds.height - window.innerHeight);

                // Convert to the image index.
                const imageIndex = Math.min(
                    numberOfImages - 1,
                    Math.ceil(scrollFraction * numberOfImages),
                );

                // Draw it if we are in bound.
                if (imageIndex >= 0 && imageIndex < numberOfImages)
                    requestAnimationFrame(() => outputImage.src = imageSrcs[imageIndex]);
            });
        }
    }

    customElements.define("graphics-element", Graphics);
</script>