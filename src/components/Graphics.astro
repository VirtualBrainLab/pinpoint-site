---
import type GraphicsImporter from "../scripts/graphics-importer";
interface Props {
	graphicsImporter: GraphicsImporter;
	alt: string;
}

const { graphicsImporter, alt } = Astro.props;
---
{graphicsImporter.getImageSrcs().then((srcs) => (
    <!--suppress HtmlUnknownTag -->
<graphics-element data-srcs={JSON.stringify(srcs)}>
    {
        graphicsImporter.getFirstImageMetadata().then(({default: {src, width, height}}) => (
                <img class="border max-w-full" src={src} width={width} height={height}
                     alt={alt}/>
        ))
    }
</graphics-element>
    ))}

<script>
    class Graphics extends HTMLElement {
        connectedCallback() {
            // Get components.
            const imageSrcs = JSON.parse(this.dataset.srcs ?? "[]");
            const numberOfImages = imageSrcs.length;
            const outputImage = this.querySelector("img") ?? (() => {
                throw new Error("Failed to get output image element");
            })();

            // Bind scroll event to draw images.
            window.addEventListener("scroll", () => {
                // Get the container bounds at this point.
                const containerBounds =
                    outputImage.parentElement?.parentElement?.parentElement?.parentElement?.getBoundingClientRect() ??
                    (() => {
                        throw new Error("Failed to get canvas containing element and bounds");
                    })();

                // Calculate where in the container we are.
                const scrollFraction =
                    (document.documentElement.scrollTop - containerBounds.top) /
                    (containerBounds.height);

                // Convert to the image index.
                const imageIndex = Math.min(
                    numberOfImages - 1,
                    Math.ceil(scrollFraction * numberOfImages),
                );

                // Draw it
                requestAnimationFrame(() => outputImage.src = imageSrcs[Math.max(0, Math.min(imageIndex, numberOfImages - 1))]);
            });
        }
    }

    customElements.define("graphics-element", Graphics);
</script>